<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Booking Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    .loader {
      border-top-color: #4a0890;
      animation: spin 1s linear infinite;
      border: 8px solid #fdefff;
      border-radius: 50%;
      width: 60px;
      height: 60px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Main Content Area -->
  <main class="flex-1 bg-gray-100 p-4 md:p-8">
    <!-- Filter Section -->
    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-4">
      <div>
        <label for="statusFilter" class="block text-xs font-medium text-gray-700">ค้นหาตามสถานะ</label>
        <select id="statusFilter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
          <option value="">All</option>
          <option value="รอการยืนยัน">รอการยืนยัน</option>
          <option value="ยืนยันแล้ว">ยืนยันแล้ว</option>
          <option value="ยกเลิก">ยกเลิก</option>
          <option value="เสร็จสิ้น">เสร็จสิ้น</option>
        </select>
      </div>
      <div>
        <label for="locationFilter" class="block text-xs font-medium text-gray-700">กรองตามสถานที่</label>
        <input type="text" id="locationFilter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="พิมพ์สถานที่">
      </div>
      <div>
        <label for="dateSort" class="block text-xs font-medium text-gray-700">เรียงตามวันที่</label>
        <select id="dateSort" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
          <option value="latest">วันที่ล่าสุด</option>
          <option value="oldest">วันที่เก่าสุด</option>
        </select>
      </div>
      <button id="applyFiltersButton" class="mt-6 py-2 px-4 bg-indigo-800 text-white rounded-md hover:bg-indigo-600">คัดกรองข้อมูล</button>
    </div>

    <!-- Card Display Section -->
    <div id="filteredData" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <!-- Cards will be inserted here -->
    </div>

    <!-- Pagination Controls -->
    <div id="paginationControls" class="mt-6 flex justify-center space-x-2">
      <!-- Pagination buttons will be inserted here -->
    </div>
  </main>

  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
    <div class="loader"></div>
  </div>

  <script>
    const LIFF_ID = '2005629952-2p0n3ERO';  // Replace with your LIFF ID
    const DETAILS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzwYNUuM_f7MjyGD56I_4B9O7MnY3MEV13o8hDkMmIcRjZfnH0EtbgTiG41POV1WUg01w/exec';
    const CARDS_PER_PAGE = 5;
    let currentPage = 1;
    let totalPages = 1;

    window.onload = function () {
      initializeLiff();
    };

    async function initializeLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (liff.isLoggedIn()) {
          getUserProfile();
        } else {
          liff.login();
        }
      } catch (error) {
        console.error('Error initializing LIFF:', error);
      }
    }

    async function getUserProfile() {
      try {
        const profile = await liff.getProfile();
        document.getElementById('userId').value = profile.userId;
        document.getElementById('displayName').value = profile.displayName;
        fetchData(profile.userId);
      } catch (error) {
        console.error('Error getting profile data:', error);
      }
    }

    async function fetchData(userId) {
      showLoading(true);
      try {
        const response = await fetch(DETAILS_SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action: 'fetchData', userId: userId })
        });

        const data = await response.json();
        const userBookings = data.filter(row => row.userId === userId);

        if (userBookings.length > 0) {
          displayData(userBookings);
        } else {
          console.log('No data found for userId:', userId);
        }
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        showLoading(false);
      }
    }

    function displayData(userBookings) {
      const filteredData = document.getElementById('filteredData');
      filteredData.innerHTML = ''; // Clear previous data

      userBookings.forEach(booking => {
        const card = document.createElement('div');
        card.classList.add('bg-white', 'p-4', 'rounded-lg', 'shadow-md');
        card.innerHTML = `
          <h3 class="text-lg font-semibold mb-2">${booking.name}</h3>
          <p class="text-sm text-gray-700"><strong>บริการ:</strong> ${booking.service}</p>
          <p class="text-sm text-gray-700"><strong>สถานที่:</strong> ${booking.locationservice}</p>
          <p class="text-sm text-gray-700"><strong>เบอร์โทร:</strong> ${booking.phonenumber}</p>
          <p class="text-sm text-gray-700"><strong>อีเมล:</strong> ${booking.note}</p>
          <p class="text-sm text-gray-700"><strong>วันที่:</strong> ${booking.date}</p>
          <p class="text-sm text-gray-700"><strong>เวลา:</strong> ${booking.time}</p>
          <p class="text-sm text-gray-700"><strong>สถานะ:</strong> ${booking.status}</p>
          <div class="mt-4 flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2">
            <button class="confirm-btn bg-green-500 text-white px-4 py-2 rounded">Confirm</button>
            <button class="cancel-btn bg-red-500 text-white px-4 py-2 rounded">Cancel</button>
            <button class="complete-btn bg-blue-500 text-white px-4 py-2 rounded">Complete</button>
            <button class="reminder-btn bg-yellow-500 text-white px-4 py-2 rounded">Send Reminder</button>
          </div>
        `;
        filteredData.appendChild(card);
      });

      attachEventListeners();
      createPaginationControls(userBookings);
    }

    function createPaginationControls(userBookings) {
      const paginationControls = document.getElementById('paginationControls');
      paginationControls.innerHTML = '';

      totalPages = Math.ceil(userBookings.length / CARDS_PER_PAGE);
      const maxVisibleButtons = 3;
      const startPage = Math.max(1, currentPage - Math.floor(maxVisibleButtons / 2));
      const endPage = Math.min(totalPages, startPage + maxVisibleButtons - 1);

      const prevButton = document.createElement('button');
      prevButton.textContent = 'Previous';
      prevButton.disabled = currentPage === 1;
      prevButton.classList.add('px-4', 'py-2', 'bg-indigo-800', 'text-white', 'rounded', 'hover:bg-indigo-600', 'disabled:opacity-50');
      prevButton.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          displayData(userBookings);
        }
      });
      paginationControls.appendChild(prevButton);

      for (let i = startPage; i <= endPage; i++) {
        const pageButton = document.createElement('button');
        pageButton.textContent = i;
        pageButton.classList.add('px-4', 'py-2', 'bg-indigo-800', 'text-white', 'rounded', 'hover:bg-indigo-600');
        if (i === currentPage) {
          pageButton.classList.add('bg-indigo-600');
        }
        pageButton.addEventListener('click', () => {
          currentPage = i;
          displayData(userBookings);
        });
        paginationControls.appendChild(pageButton);
      }

      const nextButton = document.createElement('button');
      nextButton.textContent = 'Next';
      nextButton.disabled = currentPage === totalPages;
      nextButton.classList.add('px-4', 'py-2', 'bg-indigo-800', 'text-white', 'rounded', 'hover:bg-indigo-600', 'disabled:opacity-50');
      nextButton.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          displayData(userBookings);
        }
      });
      paginationControls.appendChild(nextButton);
    }

    function attachEventListeners() {
      document.querySelectorAll('.confirm-btn').forEach(button => {
        button.addEventListener('click', function () {
          const id = this.dataset.id;
          confirmBooking(id);
        });
      });

      document.querySelectorAll('.cancel-btn').forEach(button => {
        button.addEventListener('click', function () {
          const id = this.dataset.id;
          cancelBooking(id);
        });
      });

      document.querySelectorAll('.complete-btn').forEach(button => {
        button.addEventListener('click', function () {
          const id = this.dataset.id;
          completeBooking(id);
        });
      });

      document.querySelectorAll('.reminder-btn').forEach(button => {
        button.addEventListener('click', function () {
          const id = this.dataset.id;
          sendReminder(id);
        });
      });
    }

    function confirmBooking(id) {
      Swal.fire({
        title: 'Are you sure?',
        text: "You want to confirm this booking!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, confirm it!'
      }).then((result) => {
        if (result.isConfirmed) {
          showLoading(true);
          fetch(`${DETAILS_SCRIPT_URL}?action=confirmBooking&id=${encodeURIComponent(id)}`, { method: 'POST' })
            .then(response => response.text())
            .then(data => {
              showLoading(false);
              Swal.fire('Confirmed!', 'Booking has been confirmed.', 'success');
              fetchData(document.getElementById('userId').value);
            })
            .catch(error => {
              showLoading(false);
              Swal.fire('Error!', 'There was an error confirming the booking.', 'error');
              console.error('Error confirming booking:', error);
            });
        }
      });
    }

    function cancelBooking(id) {
      Swal.fire({
        title: 'Are you sure?',
        text: "You want to cancel this booking!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, cancel it!'
      }).then((result) => {
        if (result.isConfirmed) {
          showLoading(true);
          fetch(`${DETAILS_SCRIPT_URL}?action=cancelBooking&id=${encodeURIComponent(id)}`, { method: 'POST' })
            .then(response => response.text())
            .then(data => {
              showLoading(false);
              Swal.fire('Canceled!', 'Booking has been canceled.', 'success');
              fetchData(document.getElementById('userId').value);
            })
            .catch(error => {
              showLoading(false);
              Swal.fire('Error!', 'There was an error canceling the booking.', 'error');
              console.error('Error canceling booking:', error);
            });
        }
      });
    }

    function completeBooking(id) {
      Swal.fire({
        title: 'Are you sure?',
        text: "You want to mark this booking as completed!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, complete it!'
      }).then((result) => {
        if (result.isConfirmed) {
          showLoading(true);
          fetch(`${DETAILS_SCRIPT_URL}?action=completeBooking&id=${encodeURIComponent(id)}`, { method: 'POST' })
            .then(response => response.text())
            .then(data => {
              showLoading(false);
              Swal.fire('Completed!', 'Booking has been marked as completed.', 'success');
              fetchData(document.getElementById('userId').value);
            })
            .catch(error => {
              showLoading(false);
              Swal.fire('Error!', 'There was an error completing the booking.', 'error');
              console.error('Error completing booking:', error);
            });
        }
      });
    }

    function sendReminder(id) {
      Swal.fire({
        title: 'Send reminder?',
        text: "A reminder will be sent to the user.",
        icon: 'info',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, send it!'
      }).then((result) => {
        if (result.isConfirmed) {
          showLoading(true);
          fetch(`${DETAILS_SCRIPT_URL}?action=sendReminder&id=${encodeURIComponent(id)}`, { method: 'POST' })
            .then(response => response.text())
            .then(data => {
              showLoading(false);
              Swal.fire('Reminder Sent!', 'The reminder has been sent successfully.', 'success');
              fetchData(document.getElementById('userId').value);
            })
            .catch(error => {
              showLoading(false);
              Swal.fire('Error!', 'There was an error sending the reminder.', 'error');
              console.error('Error sending reminder:', error);
            });
        }
      });
    }

    function showLoading(show) {
      const spinner = document.getElementById('loadingSpinner');
      if (show) {
        spinner.classList.remove('hidden');
      } else {
        spinner.classList.add('hidden');
      }
    }

    document.getElementById('applyFiltersButton').addEventListener('click', function () {
      fetchData(document.getElementById('userId').value);
    });

  </script>

</body>

</html>
