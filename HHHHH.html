<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ประวัติการนัดหมาย</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
    <style>body{font-family: "Noto Sans Thai", sans-serif;}</style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzwYNUuM_f7MjyGD56I_4B9O7MnY3MEV13o8hDkMmIcRjZfnH0EtbgTiG41POV1WUg01w/exec';
        const LIFF_ID = '2005629952-2p0n3ERO';


        let bookings = [];
        let filteredBookings = [];
        let currentPage = 1;
        const itemsPerPage = 10;


        window.onload = function () {
            initializeLiff();
            const userlineidInput = document.getElementById('userlineid');
            userlineidInput.addEventListener('input', function() {
                const userlineid = userlineidInput.value.trim();
                if (userlineid) {
                    applyFilter();
                }
            });


            const filterDateInput = document.getElementById('filterDate');
            filterDateInput.addEventListener('input', applyFilter);


            const filterStatusInput = document.getElementById('filterStatus');
            filterStatusInput.addEventListener('change', applyFilter);
        };


        async function initializeLiff() {
            try {
                await liff.init({ liffId: `${LIFF_ID}` }); // Replace with your LIFF ID
                if (liff.isLoggedIn()) {
                    getUserProfile();
                } else {
                    liff.login();
                }
            } catch (error) {
                console.error('LIFF Initialization failed', error);
            }
        }


        async function getUserProfile() {
            try {
                const profile = await liff.getProfile();
                document.getElementById('userlineid').value = profile.userId;
                applyFilter(); // Apply filter immediately using the user's Line ID
            } catch (error) {
                console.error('Error getting profile data:', error);
            }
        }


        async function applyFilter() {
            const userlineid = document.getElementById('userlineid').value.trim();
            const filterDate = document.getElementById('filterDate').value;
            const filterStatus = document.getElementById('filterStatus').value;
            document.getElementById('historyTable').innerHTML = '<p class="text-center text-gray-500">กำลังโหลดข้อมูล...</p>';
            await fetchHistory(userlineid, filterDate, filterStatus);
        }


        async function fetchHistory(userlineid = '', filterDate = '', filterStatus = '') {
            try {
                if (!userlineid) {
                    displayHistory([]);
                    return;
                }


                const response = await fetch(`${WEB_APP_URL}?action=fetchBookings`);
                if (!response.ok) throw new Error('Network response was not ok');


                bookings = await response.json();
                filteredBookings = bookings.filter(booking => {
                    const bookingDate = booking.date.split('-').reverse().join('-');
                    const dateMatches = !filterDate || bookingDate === filterDate;
                    const statusMatches = !filterStatus || booking.status === filterStatus;
                    const userMatches = !userlineid || booking.userlineid === userlineid;
                    return dateMatches && statusMatches && userMatches;
                });


                sortBookings(true);
            } catch (error) {
                console.error('There was a problem with the fetch operation:', error);
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลได้ โปรดลองใหม่อีกครั้ง', 'error');
                document.getElementById('historyTable').innerHTML = '<p class="text-center text-gray-500">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>';
            }
        }


        function sortBookings(byLatest = true) {
            filteredBookings.sort((a, b) => {
                const dateA = new Date(a.date.split('-').reverse().join('-') + ' ' + a.time);
                const dateB = new Date(b.date.split('-').reverse().join('-') + ' ' + b.time);
                return byLatest ? dateB - dateA : dateA - dateB;
            });
            displayHistory();
        }


        function displayHistory() {
            const historyTable = document.getElementById('historyTable');
            historyTable.innerHTML = '';
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedBookings = filteredBookings.slice(start, end);


            if (paginatedBookings.length === 0) {
                historyTable.innerHTML = '<p class="text-center text-gray-500">ไม่มีข้อมูลการนัดหมาย</p>';
                return;
            }


            paginatedBookings.forEach((booking) => {
                const bookingDiv = document.createElement('div');
                bookingDiv.classList.add('bg-gray-100', 'px-4', 'py-2','shadow-lg', 'rounded-md', 'space-y-2');


                let cancelButtonHtml = '';
                if (booking.status !== 'ยกเลิก' && booking.status !== 'เสร็จสิ้น') {
                    cancelButtonHtml = `<button class="px-2 py-1 bg-red-500 text-white text-sm rounded-md" onclick="cancelBooking('${booking.id}')">ยกเลิกนัดหมาย</button>`;
                }


                bookingDiv.innerHTML = `
                    <div class="flex flex-col items-start gap-2">
                        <div class="flex justify-between w-full">
                            <p class="font-bold text-md"><strong>คุณ:</strong> ${booking.name}</p>
                            <div class="flex justify-end">${cancelButtonHtml}</div>
                        </div>
                        <div>
                            <p class="text-sm"><strong>บริการ:</strong> ${booking.service}</p>
                            <p class="text-sm"><strong>บุคลากร:</strong> ${booking.locationservice}</p>
                            <p class="text-sm"><strong>วันที่:</strong> ${booking.date}</p>
                            <p class="text-sm"><strong>เวลา:</strong> ${booking.time}</p>
                            <p class="text-sm"><strong>สถานะ:</strong> ${booking.status}</p>
                        </div>
                    </div>
                `;


                historyTable.appendChild(bookingDiv);
            });


            updatePaginationButtons();
        }


        function updatePaginationButtons() {
            const paginationDiv = document.getElementById('pagination');
            paginationDiv.innerHTML = '';
            const totalPages = Math.ceil(filteredBookings.length / itemsPerPage);


            const startPage = Math.max(1, currentPage - 1);
            const endPage = Math.min(totalPages, currentPage + 1);


            if (currentPage > 1) {
                const prevButton = document.createElement('button');
                prevButton.classList.add('px-4', 'py-2', 'bg-gray-800', 'text-white', 'rounded-md');
                prevButton.textContent = 'ย้อนกลับ';
                prevButton.onclick = () => {
                    currentPage--;
                    displayHistory();
                };
                paginationDiv.appendChild(prevButton);
            }


            for (let page = startPage; page <= endPage; page++) {
                const pageButton = document.createElement('button');
                pageButton.classList.add('px-4', 'py-2', 'bg-gray-800', 'text-white', 'rounded-md');
                pageButton.textContent = page;
                if (page === currentPage) {
                    pageButton.classList.add('bg-gray-600');
                }
                pageButton.onclick = () => {
                    currentPage = page;
                    displayHistory();
                };
                paginationDiv.appendChild(pageButton);
            }


            if (currentPage < totalPages) {
                const nextButton = document.createElement('button');
                nextButton.classList.add('px-4', 'py-2', 'bg-gray-800', 'text-white', 'rounded-md');
                nextButton.textContent = 'ถัดไป';
                nextButton.onclick = () => {
                    currentPage++;
                    displayHistory();
                };
                paginationDiv.appendChild(nextButton);
            }
        }


        async function cancelBooking(bookingId) {
          try {
              const result = await Swal.fire({
                  title: 'ยืนยันการยกเลิกนัดหมาย',
                  text: 'คุณแน่ใจว่าต้องการยกเลิกนัดหมายนี้หรือไม่?',
                  icon: 'warning',
                  showCancelButton: true,
                  confirmButtonText: 'ใช่, ยกเลิกมัน!',
                  cancelButtonText: 'ยกเลิก'
              });

              if (result.isConfirmed) {
                  const response = await fetch(`${WEB_APP_URL}?action=cancelBooking&id=${encodeURIComponent(bookingId)}`, {
                      method: 'POST'
                  });
                  if (!response.ok) throw new Error('Network response was not ok');

                  Swal.fire('สำเร็จ!', 'นัดหมายถูกยกเลิก', 'success');
                  applyFilter(); // Refresh the filtered results after cancellation.
              }
          } catch (error) {
              console.error('There was a problem with the fetch operation:', error);
              Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถยกเลิกนัดหมายได้ โปรดลองใหม่อีกครั้ง', 'error');
          }
      }

    </script>
</head>
<body class="bg-gray-100 m-5">
    <div class="max-w-xl mx-auto p-6">
        <div class="py-4 px-4 border-2 border-blue-700 rounded-md mb-6">
            <div class="text-xl text-blue-800 text-bold">ประวัติการนัดหมาย</div>
            <div class="text-sm">BOOKING IIIRN</div>
        </div>
        <div class="flex justify-between space-x-2 mb-4">
            <input id="userlineid" type="text" class="border p-2 rounded-md w-full" placeholder="กรอก User Line ID เพื่อกรองนัดหมาย" style="display:none;">
            <input type="date" id="filterDate" class="border p-2 rounded-md">
            <select id="filterStatus" class="border p-2 rounded-md">
                <option value="">ทั้งหมด</option>
                <option value="รอการยืนยัน">รอการยืนยัน</option>
                <option value="ยืนยันแล้ว">ยืนยันแล้ว</option>
                <option value="ยกเลิก">ยกเลิก</option>
                <option value="เสร็จสิ้น">เสร็จสิ้น</option>
            </select>
        </div>
        <div id="pagination" class="flex justify-end mb-4">
            <!-- Pagination buttons will be rendered here -->
        </div>
        <div id="historyTable" class="space-y-4">
            <!-- การนัดหมายจะถูกแสดงที่นี่ -->
        </div>
    </div>
</body>
</html>
