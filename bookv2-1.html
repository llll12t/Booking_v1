<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <!-- Flatpickr CSS/JS + Thai locale -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
  <style>
    body { font-family: 'Noto Sans Thai', sans-serif; }
    select {
      appearance: none;
      background-image:
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="7" viewBox="0 0 10 7"><path fill="none" stroke="%23666" stroke-width="2" d="M1 1l4 4 4-4"/></svg>');
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      padding-right: 2rem;
    }
    .loading-overlay {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(30,41,59,0.8);
      display: none; align-items:center; justify-content:center; z-index:50;
    }
    .loading-spinner {
      border:8px solid #fff; border-top:8px solid #1e293b;
      border-radius:50%; width:60px; height:60px; animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
    .popup {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(30,41,59,0.5);
      display: none; align-items:center; justify-content:center; z-index:60;
    }
    .popup-content {
      background:#fff; padding:1.5rem; border-radius:0.5rem; width:90%; max-width:320px;
    }
    /* Flatpickr container centering */
    #inlineCalendar-wrapper {
      max-width: 320px; margin: 0 auto 1rem;
    }
    #inlineCalendar .flatpickr-calendar.inline {
      width:100% !important; border-radius:0.75rem; box-shadow:none;
    }
    #inlineCalendar .flatpickr-day {
      padding:0.75rem; border-radius:0.5rem; margin:2px;
    }
    #inlineCalendar .flatpickr-day.today {
      border:1px solid #4ade80 !important;
    }
    #inlineCalendar .flatpickr-day.selected {
      background:#10b981 !important; color:#fff !important;
    }
    #inlineCalendar .flatpickr-day.past {
      opacity:0.4; pointer-events:none;
    }
    #timeDropdown {
      display:grid; grid-template-columns:repeat(3,1fr); gap:0.5rem;
    }
    .time-option {
      display:flex; justify-content:space-between; align-items:center;
      padding:0.75rem; border-radius:0.5rem; background:#fff;
      box-shadow:0 1px 2px rgba(0,0,0,0.1); cursor:pointer;
    }
    .time-option.selected { background:#10b981; color:#fff; }
    .badge {
      border-radius:9999px; padding:0.25rem 0.5rem;
      font-size:0.75rem; font-weight:600; min-width:2.5rem; text-align:center;
    }
    .badge.available { background:#dcfce7; color:#166534; }
    .badge.full      { background:#fee2e2; color:#b91c1c; }
    .opacity-50 { opacity:0.5; pointer-events:none; }
  </style>
</head>
<body class="bg-white min-h-screen flex flex-col">

  <!-- Loading Spinner -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- Popup -->
  <div class="popup" id="popup">
    <div class="popup-content" id="popupContent"></div>
  </div>

  <div class="w-full max-w-md mx-auto p-4 flex-1">

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <p id="greetingPrefix" class="text-sm text-gray-500">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤</p>
        <h1 id="greetingName" class="text-xl font-bold">LINE NAME</h1>
      </div>
      <img id="greetingAvatar" src="" alt="Avatar" class="w-12 h-12 rounded-full bg-gray-200" />
    </div>

    <!-- Booking Form -->
    <form id="bookingForm" novalidate>

      <!-- Step 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ -->
      <div class="step" id="step1">
        <div id="serviceCards" class="grid grid-cols-2 gap-4 mb-6"></div>
        <button type="button" id="nextToStep2" class="w-full py-3 bg-black text-white rounded-lg font-bold">
          ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        </button>
      </div>

      <!-- Step 2: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / ‡πÄ‡∏ß‡∏•‡∏≤ -->
      <div class="step hidden" id="step2">
        <label class="block mb-2 font-semibold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
        <div id="inlineCalendar-wrapper">
          <div id="inlineCalendar"></div>
        </div>
        <label class="block mb-2 font-semibold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤:</label>
        <div id="timeDropdown" class="mb-6">
          <div class="text-gray-400 text-sm text-center py-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô</div>
        </div>
        <div class="flex justify-between">
          <button type="button" id="backToStep1" class="px-4 py-2 border rounded-lg font-bold">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
          <button type="button" id="nextToStep3" class="px-4 py-2 bg-black text-white rounded-lg font-bold">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>
      </div>

      <!-- Step 3: ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß -->
      <div class="step hidden" id="step3">
        <input type="text" id="name" name="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" class="w-full mb-3 rounded-lg border p-3" required />
        <input type="tel" id="phonenumber" name="phonenumber" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠" class="w-full mb-3 rounded-lg border p-3" required />
        <textarea id="note" name="note" rows="4" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" class="w-full mb-6 rounded-lg border p-3"></textarea>
        <div class="flex justify-between">
          <button type="button" id="backToStep2" class="px-4 py-2 border rounded-lg font-bold">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
          <button type="button" id="nextToStep4" class="px-4 py-2 bg-black text-white rounded-lg font-bold">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>
      </div>

      <!-- Step 4: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
      <div class="step hidden" id="step4">
        <div class="bg-gray-50 rounded-lg p-4 mb-6 space-y-2">
          <div class="flex justify-between"><span>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span><span id="confirmService" class="font-semibold"></span></div>
          <div class="flex justify-between"><span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span><span id="confirmDate" class="font-semibold"></span></div>
          <div class="flex justify-between"><span>‡πÄ‡∏ß‡∏•‡∏≤</span><span id="confirmTime" class="font-semibold"></span></div>
          <div class="flex justify-between"><span>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</span><span id="confirmName" class="font-semibold"></span></div>
          <div class="flex justify-between"><span>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</span><span id="confirmPhone" class="font-semibold"></span></div>
          <div class="flex justify-between"><span>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</span><span id="confirmNote" class="font-semibold"></span></div>
        </div>
        <div class="flex justify-between">
          <button type="button" id="backToStep3" class="px-4 py-2 border rounded-lg font-bold">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
          <button type="submit" id="confirmBooking" class="w-full py-3 bg-black text-white rounded-lg font-bold ml-4">
            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢
          </button>
        </div>
      </div>

      <!-- Hidden fields -->
      <input type="hidden" id="time" name="time" />
      <input type="hidden" id="selectedServices" name="selectedServices" />
      <input type="hidden" id="selectedServiceNames" name="selectedServiceNames" />
      <input type="hidden" id="userlineid" name="userlineid" value="" />
      <input type="hidden" name="action" value="makeBooking" />

    </form>
  </div>

  <script>
    let holidayDates = [], monthAvailability = {}, selectedDate = '';
    let currentStep = 1, isSubmitting = false;

    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw-Yjv94ffGn98tweURPh1cxDfegwcffZg8dZ_YsZDqwxi2L4G6Q_hIETG1Wv5IMP3V/exec';
    const LIFF_ID = '2006029649-bj0ez4Og';

    function getGreeting(hour) {
      if (hour >= 5 && hour < 12) return '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤';
      if (hour >= 12 && hour < 13) return '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á';
      if (hour >= 13 && hour < 17) return '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡∏ö‡πà‡∏≤‡∏¢';
      if (hour >= 17 && hour < 19) return '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏¢‡πá‡∏ô';
      return '‡∏£‡∏≤‡∏ï‡∏£‡∏µ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå';
    }

    function showStep(step) {
      document.querySelectorAll('.step').forEach(el => el.classList.add('hidden'));
      document.getElementById('step'+step).classList.remove('hidden');
      currentStep = step;
      if (step === 4) updateConfirmation();
    }

    function updateConfirmation(){
      document.getElementById('confirmService').textContent = document.getElementById('selectedServiceNames').value;
      document.getElementById('confirmName').textContent    = document.getElementById('name').value;
      document.getElementById('confirmPhone').textContent   = document.getElementById('phonenumber').value;
      document.getElementById('confirmNote').textContent    = document.getElementById('note').value || '-';
      document.getElementById('confirmDate').textContent    = selectedDate.split('-').reverse().join('/');
      document.getElementById('confirmTime').textContent    = document.getElementById('time').value;
    }

    function showPopup(message){
      popupContent.innerHTML = `<div class="text-center py-4">${message}</div>
                                <div class="text-center mt-4">
                                  <button onclick="hidePopup()" class="px-4 py-2 bg-gray-300 rounded-lg">‡∏õ‡∏¥‡∏î</button>
                                </div>`;
      popup.style.display = 'flex';
    }
    function hidePopup(){ popup.style.display = 'none'; }
    function showLoading(on){ loadingOverlay.style.display = on ? 'flex' : 'none'; }

    async function fetchMonthAvailability(year, month) {
      try {
        const res = await fetch(`${WEB_APP_URL}?action=getMonthAvailability&year=${year}&month=${month}`);
        monthAvailability = await res.json();
      } catch (e) {
        console.error('fetchMonthAvailability error', e);
      }
    }

    function formatDate(d) {
      const y = d.getFullYear();
      const m = ('0'+(d.getMonth()+1)).slice(-2);
      const day = ('0'+d.getDate()).slice(-2);
      return `${y}-${m}-${day}`;
    }
    function initCalendar() {
      const today = new Date(); today.setHours(0,0,0,0);
      fetchMonthAvailability(today.getFullYear(), ('0'+(today.getMonth()+1)).slice(-2));
      flatpickr("#inlineCalendar", {
        inline: true,
        locale: 'th',
        dateFormat: "Y-m-d",
        disable: [
          date => {
            const key = formatDate(date);
            return date < today
              || holidayDates.includes(key)
              || monthAvailability[key] === 'full';
          }
        ],
        onDayCreate: (dObj,dStr,fp,dayElem) => {
          const key = formatDate(dayElem.dateObj);
          if (dayElem.dateObj < today) {
            dayElem.classList.add('past');
          } else if (holidayDates.includes(key)) {
            dayElem.textContent = "‚ùå";
          } else if (monthAvailability[key] === 'full') {
            dayElem.textContent = "‡πÄ‡∏ï‡πá‡∏°";
            dayElem.classList.add("flatpickr-disabled");
          }
        },
        onMonthChange: async (sd,ds,fp) => {
          await fetchMonthAvailability(fp.currentYear, ('0'+(fp.currentMonth+1)).slice(-2));
          fp.redraw();
        },
        onChange: (selectedDates, dateStr) => {
          selectedDate = dateStr;
          if (dateStr) {
            timeDropdown.innerHTML = `<div class="text-gray-800 text-sm text-center py-2">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà..</div>`;
            checkAvailability(dateStr);
          } else {
            resetTimeDropdown();
          }
        }
      });
    }

    async function checkAvailability(dateStr){
      try {
        const res = await fetch(`${WEB_APP_URL}?action=checkAvailability&date=${dateStr}`);
        const avail = await res.json().then(j=>j.availability);
        timeDropdown.innerHTML = '';
        Object.entries(avail).forEach(([t,i])=>{
          const div = document.createElement('div');
          div.className = 'time-option'; div.dataset.value = t;
          const spanT = document.createElement('span'); spanT.textContent = t;
          const badge = document.createElement('span');
          badge.className = 'badge ' + (i.remaining>0?'available':'full');
          badge.textContent = `${i.remaining}/${i.total}`;
          if (i.status!=='Available') div.classList.add('opacity-50');
          else div.onclick = () => {
            [...timeDropdown.children].forEach(c=>c.classList.remove('selected'));
            div.classList.add('selected');
            time.value = t;
          };
          div.append(spanT, badge);
          timeDropdown.appendChild(div);
        });
      } catch (e) {
        showPopup('‡πÇ‡∏´‡∏•‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        console.error(e);
      }
    }
    function resetTimeDropdown() {
      timeDropdown.innerHTML = `<div class="text-gray-400 text-sm text-center py-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô</div>`;
      time.value = '';
    }

    async function fetchServiceData(){
      try {
        const res = await fetch(`${WEB_APP_URL}?action=fetchServices`);
        const services = await res.json();
        services.forEach(s=>{
          const c = document.createElement('div');
          c.className = 'p-4 border rounded-lg cursor-pointer';
          c.innerHTML = `<div class="font-bold">${s.name}</div>
                         <div class="text-sm text-gray-600">‡∏£‡∏≤‡∏Ñ‡∏≤: ${s.price}</div>`;
          c.dataset.id = s.id; c.dataset.name = s.name; c.dataset.price = s.price;
          c.onclick = () => {
            c.classList.toggle('bg-green-100');
            updateSelectedServices();
          };
          serviceCards.appendChild(c);
        });
      } catch(e){ console.error(e); }
    }
    function updateSelectedServices(){
      const sel = [...serviceCards.querySelectorAll('.bg-green-100')];
      const ids = sel.map(c=>c.dataset.id);
      const names = sel.map(c=>`${c.dataset.name} (${c.dataset.price})`).join(', ');
      selectedServices.value = JSON.stringify(ids);
      selectedServiceNames.value = names;
    }

    async function fetchHolidayDates(){
      try {
        const res = await fetch(`${WEB_APP_URL}?action=checkAvailability&getHolidays=true`);
        holidayDates = await res.json().then(j=>j.holidays);
      } catch(e){ console.error(e); }
    }

    // ‡∏™‡πà‡∏á Flex Message ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
    async function sendFlexMessage() {
      const services = document.getElementById('selectedServiceNames').value;
      const name     = document.getElementById('name').value;
      const phone    = document.getElementById('phonenumber').value;
      const date     = selectedDate.split('-').reverse().join('/');
      const timeVal  = document.getElementById('time').value;
      const note     = document.getElementById('note').value || '-';

      const bubble = {
        type: 'bubble',
        header: {
          type: 'box',
          layout: 'vertical',
          contents: [
            { type: 'text', text: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì', weight: 'bold', size: 'lg', align: 'center' }
          ]
        },
        body: {
          type: 'box',
          layout: 'vertical',
          spacing: 'sm',
          contents: [
            { type: 'text', text: `üõé ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£: ${services}`, size: 'sm', wrap: true },
            { type: 'text', text: `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${date}`, size: 'sm' },
            { type: 'text', text: `‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: ${timeVal}`, size: 'sm' },
            { type: 'text', text: `üë§ ‡∏ä‡∏∑‡πà‡∏≠: ${name}`, size: 'sm', wrap: true },
            { type: 'text', text: `üì± ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: ${phone}`, size: 'sm' },
            { type: 'text', text: `üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${note}`, size: 'sm', wrap: true }
          ]
        }
      };

      try {
        await liff.sendMessages([{
          type: 'flex',
          altText: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì',
          contents: bubble
        }]);
        console.log('Flex message sent');
      } catch (err) {
        console.error('Error sending flex message:', err);
      }
    }

    // ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
    document.getElementById('nextToStep2').onclick = () => {
      if (!JSON.parse(selectedServices.value||'[]').length) {
        showPopup('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
        return; }
      showStep(2);
    };
    document.getElementById('backToStep1').onclick = () => showStep(1);
    document.getElementById('nextToStep3').onclick = () => {
      if (!selectedDate) { showPopup('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'); return; }
      if (!time.value)    { showPopup('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤'); return; }
      showStep(3);
    };
    document.getElementById('backToStep2').onclick = () => showStep(2);
    document.getElementById('nextToStep4').onclick = () => {
      const nameVal  = document.getElementById('name').value.trim();
      const phoneVal = document.getElementById('phonenumber').value.trim();
      if (!nameVal)  { showPopup('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•'); return; }
      if (!phoneVal) { showPopup('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠'); return; }
      showStep(4);
    };
    document.getElementById('backToStep3').onclick = () => showStep(3);

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞ Flex Message
    bookingForm.onsubmit = async e => {
      e.preventDefault();
      if (isSubmitting) return;
      isSubmitting = true; showLoading(true);
      try {
        const fd = new FormData(bookingForm);
        fd.append('date', selectedDate);
        await fetch(WEB_APP_URL, { method:'POST', body:fd });
        await sendFlexMessage();
        showPopup('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå');
      } catch(e) {
        console.error(e);
        showPopup('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      } finally {
        isSubmitting = false; showLoading(false);
      }
    };

    document.addEventListener('DOMContentLoaded', async () => {
      showLoading(true);
      const hr = new Date().getHours();
      greetingPrefix.textContent = getGreeting(hr);
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); }
      else {
        const profile = await liff.getProfile();
        greetingName.textContent = profile.displayName;
        greetingAvatar.src = profile.pictureUrl;
        userlineid.value = profile.userId;
        await fetchServiceData();
        await fetchHolidayDates();
        initCalendar();
      }
      showLoading(false);
    });

    // ‡∏î‡∏∂‡∏á‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
    async function fetchServiceData(){
      try {
        const res = await fetch(`${WEB_APP_URL}?action=fetchServices`);
        const services = await res.json();
        services.forEach(s=>{
          const c = document.createElement('div');
          c.className = 'p-4 border rounded-lg cursor-pointer';
          c.innerHTML = `<div class="font-bold">${s.name}</div>
                         <div class="text-sm text-gray-600">‡∏£‡∏≤‡∏Ñ‡∏≤: ${s.price}</div>`;
          c.dataset.id = s.id; c.dataset.name = s.name; c.dataset.price = s.price;
          c.onclick = () => {
            c.classList.toggle('bg-green-100');
            updateSelectedServices();
          };
          serviceCards.appendChild(c);
        });
      } catch(e){ console.error(e); }
    }
    function updateSelectedServices(){
      const sel = [...serviceCards.querySelectorAll('.bg-green-100')];
      selectedServices.value = JSON.stringify(sel.map(c=>c.dataset.id));
      selectedServiceNames.value = sel.map(c=>`${c.dataset.name} (${c.dataset.price})`).join(', ');
    }
    async function fetchHolidayDates(){
      try {
        const res = await fetch(`${WEB_APP_URL}?action=checkAvailability&getHolidays=true`);
        holidayDates = await res.json().then(j=>j.holidays);
      } catch(e){ console.error(e); }
    }
  </script>
</body>
</html>
