<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Booking Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
  <!-- Main Content Area -->
  <main class="flex-1 bg-gray-100 p-4 sm:p-8">
    <!-- Filter Section -->
    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-4">
      <div class="flex-1">
        <label for="statusFilter" class="block text-xs sm:text-sm font-medium text-gray-700">ค้นหาตามสถานะ</label>
        <select id="statusFilter" class="mt-1 block w-full p-2 text-xs sm:text-sm border border-gray-300 rounded-md">
          <option value="">All</option>
          <option value="รอการยืนยัน">รอการยืนยัน</option>
          <option value="ยืนยันแล้ว">ยืนยันแล้ว</option>
          <option value="ยกเลิก">ยกเลิก</option>
          <option value="เสร็จสิ้น">เสร็จสิ้น</option>
        </select>
      </div>
      <div class="flex-1">
        <label for="locationFilter" class="block text-xs sm:text-sm font-medium text-gray-700">กรองตามสถานที่</label>
        <input type="text" id="locationFilter" class="mt-1 block w-full p-2 text-xs sm:text-sm border border-gray-300 rounded-md" placeholder="พิมพ์สถานที่">
      </div>
      <button id="applyFiltersButton" class="mt-2 sm:mt-6 py-2 px-4 text-xs sm:text-sm bg-red-400 text-white rounded-md hover:bg-red-200">คัดกรองข้อมูล</button>
    </div>

    <!-- Cards Section -->
    <div id="filteredData" class="space-y-4">
      <!-- Cards will be inserted here -->
    </div>
  </main>

  <script>
    const DETAILS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzwYNUuM_f7MjyGD56I_4B9O7MnY3MEV13o8hDkMmIcRjZfnH0EtbgTiG41POV1WUg01w/exec';

    document.addEventListener('DOMContentLoaded', function () {

      // Function to fetch and populate the cards
      function fetchAndPopulateCards() {
        fetch(`${DETAILS_SCRIPT_URL}?action=fetchBookings`)
          .then(response => response.json())
          .then(details => {
            const filteredData = document.getElementById('filteredData');
            filteredData.innerHTML = ''; // Clear old data

            details.forEach(detail => {
              // Assign keyid to detail.id
              detail.id = detail.idKey;

              // Determine button states based on status
              let disableConfirm = false;
              let disableComplete = false;
              let disableCancel = false;
              let disableReminder = false;

              switch (detail.status) {
                case 'รอการยืนยัน':
                  disableComplete = true;
                  break;
                case 'ยืนยันแล้ว':
                  disableConfirm = true;
                  disableReminder = true;
                  break;
                case 'ยกเลิก':
                  disableCancel = true;
                  disableConfirm = true;
                  disableComplete = true;
                  disableReminder = true;
                  break;
                case 'เสร็จสิ้น':
                  disableConfirm = true;
                  disableCancel = true;
                  disableComplete = true;
                  disableReminder = true;
                  break;
              }

              // Create a new card
              const card = document.createElement('div');
              card.classList.add('bg-white', 'p-4', 'rounded-lg', 'shadow-md', 'space-y-2');

              // Populate the card with data
              card.innerHTML = `
                <div class="flex justify-between">
                  <h2 class="text-sm sm:text-base font-semibold">${detail.name}</h2>
                  <span class="text-xs sm:text-sm text-gray-500">${detail.status}</span>
                </div>
                <p class="text-xs sm:text-sm"><strong>บริการ:</strong> ${detail.service}</p>
                <p class="text-xs sm:text-sm"><strong>สถานที่:</strong> ${detail.locationservice}</p>
                <p class="text-xs sm:text-sm"><strong>เบอร์โทร:</strong> ${detail.phonenumber}</p>
                <p class="text-xs sm:text-sm"><strong>หมายเหตุ:</strong> ${detail.note}</p>
                <p class="text-xs sm:text-sm"><strong>วันที่:</strong> ${detail.date}</p>
                <p class="text-xs sm:text-sm"><strong>เวลา:</strong> ${detail.time}</p>
                <div class="flex space-x-2">
                  <button class="confirm-btn bg-green-500 text-white text-xs sm:text-sm px-2 py-1 rounded ${disableConfirm ? 'opacity-50 cursor-not-allowed' : ''}" ${disableConfirm ? 'disabled' : ''} data-id="${detail.idKey}">Confirm</button>
                  <button class="cancel-btn bg-red-500 text-white text-xs sm:text-sm px-2 py-1 rounded ${disableCancel ? 'opacity-50 cursor-not-allowed' : ''}" ${disableCancel ? 'disabled' : ''} data-id="${detail.idKey}">Cancel</button>
                  <button class="complete-btn bg-blue-500 text-white text-xs sm:text-sm px-2 py-1 rounded ${disableComplete ? 'opacity-50 cursor-not-allowed' : ''}" ${disableComplete ? 'disabled' : ''} data-id="${detail.idKey}">Complete</button>
                  <button class="reminder-btn bg-yellow-500 text-white text-xs sm:text-sm px-2 py-1 rounded ${disableReminder ? 'opacity-50 cursor-not-allowed' : ''}" ${disableReminder ? 'disabled' : ''} data-id="${detail.idKey}">Send Reminder</button>
                </div>
              `;

              // Append the new card to the filteredData
              filteredData.appendChild(card);
            });

            // Re-attach event listeners for the new buttons
            attachEventListeners();
          })
          .catch(error => {
            console.error('Error fetching user details:', error);
          });
      }

      // Initial card population
      fetchAndPopulateCards();

      // Attach event listeners to the action buttons
      function attachEventListeners() {
        document.querySelectorAll('.confirm-btn').forEach(button => {
          button.addEventListener('click', function () {
            const id = this.dataset.id;
            confirmBooking(id);
          });
        });

        document.querySelectorAll('.cancel-btn').forEach(button => {
          button.addEventListener('click', function () {
            const id = this.dataset.id;
            cancelBooking(id);
          });
        });

        document.querySelectorAll('.complete-btn').forEach(button => {
          button.addEventListener('click', function () {
            const id = this.dataset.id;
            completeBooking(id);
          });
        });

        document.querySelectorAll('.reminder-btn').forEach(button => {
          button.addEventListener('click', function () {
            const id = this.dataset.id;
            sendReminder(id);
          });
        });
      }

      // Action functions with card update

      function confirmBooking(id) {
        Swal.fire({
          title: 'Are you sure?',
          text: "You want to confirm this booking!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, confirm it!'
        }).then((result) => {
          if (result.isConfirmed) {
            showLoadingSpinner(true);
            fetch(`${DETAILS_SCRIPT_URL}?action=confirmBooking&id=${encodeURIComponent(id)}`, { method: 'POST' })
              .then(response => response.text())
              .then(data => {
                showLoadingSpinner(false);
                Swal.fire('Confirmed!', 'Booking has been confirmed.', 'success');
                fetchAndPopulateCards();  // Update the cards
              })
              .catch(error => {
                showLoadingSpinner(false);
                Swal.fire('Error!', 'There was an error confirming the booking.', 'error');
                console.error('Error confirming booking:', error);
              });
          }
        });
      }

      function cancelBooking(id) {
        Swal.fire({
          title: 'Are you sure?',
          text: "You want to cancel this booking!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, cancel it!'
        }).then((result) => {
          if (result.isConfirmed) {
            showLoadingSpinner(true);
            fetch(`${DETAILS_SCRIPT_URL}?action=cancelBooking&id=${encodeURIComponent(id)}`, { method: 'POST' })
              .then(response => response.text())
              .then(data => {
                showLoadingSpinner(false);
                Swal.fire('Canceled!', 'Booking has been canceled.', 'success');
                fetchAndPopulateCards();  // Update the cards
              })
              .catch(error => {
                showLoadingSpinner(false);
                Swal.fire('Error!', 'There was an error canceling the booking.', 'error');
                console.error('Error canceling booking:', error);
              });
          }
        });
      }

      function completeBooking(id) {
        Swal.fire({
          title: 'Are you sure?',
          text: "You want to mark this booking as completed!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, complete it!'
        }).then((result) => {
          if (result.isConfirmed) {
            showLoadingSpinner(true);
            fetch(`${DETAILS_SCRIPT_URL}?action=completeBooking&id=${encodeURIComponent(id)}`, { method: 'POST' })
              .then(response => response.text())
              .then(data => {
                showLoadingSpinner(false);
                Swal.fire('Completed!', 'Booking has been marked as completed.', 'success');
                fetchAndPopulateCards();  // Update the cards
              })
              .catch(error => {
                showLoadingSpinner(false);
                Swal.fire('Error!', 'There was an error completing the booking.', 'error');
                console.error('Error completing booking:', error);
              });
          }
        });
      }

      function sendReminder(id) {
        Swal.fire({
          title: 'Send reminder?',
          text: "A reminder will be sent to the user.",
          icon: 'info',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, send it!'
        }).then((result) => {
          if (result.isConfirmed) {
            showLoadingSpinner(true);
            fetch(`${DETAILS_SCRIPT_URL}?action=sendReminder&id=${encodeURIComponent(id)}`, { method: 'POST' })
              .then(response => response.text())
              .then(data => {
                showLoadingSpinner(false);
                Swal.fire('Reminder Sent!', 'The reminder has been sent successfully.', 'success');
                fetchAndPopulateCards();  // Update the cards
              })
              .catch(error => {
                showLoadingSpinner(false);
                Swal.fire('Error!', 'There was an error sending the reminder.', 'error');
                console.error('Error sending reminder:', error);
              });
          }
        });
      }

      function showLoadingSpinner(show) {
        const spinner = document.getElementById('loadingSpinner');
        if (show) {
          spinner.classList.remove('hidden');
        } else {
          spinner.classList.add('hidden');
        }
      }

      // Apply filters on the cards based on status and location
      document.getElementById('applyFiltersButton').addEventListener('click', function () {
        const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
        const locationFilter = document.getElementById('locationFilter').value.toLowerCase();

        const cards = document.querySelectorAll('#filteredData > div');
        cards.forEach(card => {
          const statusText = card.querySelector('span').textContent.toLowerCase();
          const locationText = card.querySelector('p:nth-child(4)').textContent.toLowerCase();

          const matchesStatus = statusFilter === '' || statusText === statusFilter;
          const matchesLocation = locationFilter === '' || locationText.includes(locationFilter);

          if (matchesStatus && matchesLocation) {
            card.classList.remove('hidden');
          } else {
            card.classList.add('hidden');
          }
        });
      });
    });
  </script>

</body>

</html>
